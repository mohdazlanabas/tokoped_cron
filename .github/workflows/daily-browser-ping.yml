name: Daily Browser Visit

on:
  schedule:
    - cron: "0 1 * * *"   # 01:00 UTC = 09:00 Asia/Makassar
  workflow_dispatch:

jobs:
  visit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci || npm i

      - name: Run Puppeteer check (generates artifacts/summary.txt)
        run: npm run ping

      - name: Read summary into env
        id: summary
        run: |
          echo 'SUMMARY<<EOF' >> $GITHUB_ENV
          cat artifacts/summary.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Email summary
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "Daily visit summary"
          to: "azlan@net1io.com"
          from: "Visit Agent <${{ secrets.SMTP_USER }}>"
          secure: true
          content_type: text/plain
          body: ${{ env.SUMMARY }}

      - name: Upload artifacts (logs only)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visit-artifacts
          path: |
            artifacts/visit_log.csv
            artifacts/visit_log.json
            artifacts/summary.txt
          if-no-files-found: warn